summary: Check basic core20 and later system functionality

details: |
    Verify some basic functionalities in ubuntu core (>=20): system
    snaps are present, the system is fully seeded, install a simple
    snap, check boot configuration, symlinks in /var/lib/snapd/snaps,
    snap recovery, loop devices and apparmor after a reboot works
    properly

environment:
    ROOT: /home/test/tmp/

prepare: |
    mkdir -p "$ROOT"
    chown test:test "$ROOT"

restore: |
    rm -rf "$ROOT"

execute: |
    case "$SPREAD_SYSTEM" in
      ubuntu-core-24-*)
        UC_VERSION=24
        ;;
      ubuntu-core-22-*)
        UC_VERSION=22
        ;;
      ubuntu-core-20-*)
        UC_VERSION=20
        ;;
      ubuntu-core-18-*)
        UC_VERSION=18
        ;;
      *)
        echo "Unsupported ubuntu core system, add missing case here"
        exit 1
    esac
    
    snap download pc-kernel --channel="${UC_VERSION}"/stable
    unsquashfs pc-kernel_*.snap
    rm pc-kernel_*
    sed -i "s/VERSION=.*/VERSION=2.67+test-dirty/g" ./squashfs-root/snapd-info
    snap pack squashfs-root

    echo "Executing prepare-image and expecting an error surrounding snapd / kernel versions"
    SNAPD_ALLOW_SNAPD_KERNEL_MISMATCH=false snap prepare-image --snap ./pc-kernel_*.snap "$TESTSLIB/assertions/ubuntu-core-${UC_VERSION}-amd64.model" "$ROOT" 2>&1 | tee output.log

    MATCH "error: snapd 2.68\+ is not compatible with a kernel containing snapd prior to 2.68" < output.log

    echo "Cleaning up"
    rm -rf /home/test/tmp/*

    # currently SNAPD_ALLOW_SNAPD_KERNEL_MISMATCH is set in spread.yaml, so we just avoid overriding it
    echo "Executing prepare-image with SNAPD_ALLOW_SNAPD_KERNEL_MISMATCH set, expecting a warning"
    snap prepare-image --snap ./pc-kernel_*.snap "$TESTSLIB/assertions/ubuntu-core-${UC_VERSION}-amd64.model" "$ROOT" 2>&1 | tee output.log

    MATCH "WARNING: snapd 2.68\+ is not compatible with a kernel containing snapd prior to 2.68" < output.log

    echo "Cleaning up"
    rm -rf /home/test/tmp/*

    echo "Executing prepare-image with --allow-snapd-kernel-mismatch set, expecting a warning"
    SNAPD_ALLOW_SNAPD_KERNEL_MISMATCH=false snap prepare-image --allow-snapd-kernel-mismatch --snap ./pc-kernel_*.snap "$TESTSLIB/assertions/ubuntu-core-${UC_VERSION}-amd64.model" "$ROOT" 2>&1 | tee output.log

    MATCH "WARNING: snapd 2.68\+ is not compatible with a kernel containing snapd prior to 2.68" < output.log
